rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the requesting user's profile data
    // Important: Only call this after checking if the user document exists!
    function userProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    match /companies/{companyId} {
      // Any authenticated user can create a company document.
      // This is part of the initial registration flow.
      allow create: if request.auth != null;

      // Allow get/update only if the user document exists and they are an admin of that company.
      allow get, update: if
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        userProfile().company_id == companyId &&
        userProfile().role == 'Admin';

      // Rules for sub-collections
      match /roles/{roleId} {
        allow get, list, create: if
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          userProfile().company_id == companyId &&
          userProfile().role == 'Admin';
      }

      match /invites/{inviteId} {
        allow get, list, create: if
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          userProfile().company_id == companyId &&
          userProfile().role == 'Admin';

        // Allow anyone to read a PENDING invite. This is for the registration page.
        allow get: if resource.data.status == 'pending';

        // Allow the user who is accepting the invite to update it from pending to accepted.
        allow update: if
          request.auth.uid == request.resource.data.accepted_by_uid &&
          resource.data.status == 'pending';
      }
    }

    match /users/{userId} {
      // A user can create their own user document.
      allow create: if request.auth.uid == userId;

      // A user can read or update their own document.
      allow read, update: if request.auth.uid == userId;

      // An admin can list the users in their company.
      allow list: if
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        userProfile().role == 'Admin';
    }
  }
}
